<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/common.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; }
      header { display:flex; justify-content:space-between; align-items:center; }
      button { padding:8px 12px; }
      table { width:100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border: 1px solid #ddd; padding: 8px; }
    </style>
  </head>
  <body>
    <header>
      <h2>Admin Dashboard</h2>
      <button id="logoutBtn">Sign out</button>
    </header>

    <div id="gateMsg">Checking admin accessâ€¦</div>

    <section id="content" style="display:none">
      <h3>Students</h3>
      <table id="studentsTable">
        <thead><tr><th>ID</th><th>Data (json)</th><th>Created</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <script>
      async function requireAdmin() {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        const { data: prof, error } = await window.supabase
          .from('profiles').select('is_admin').single();

        if (error || !prof?.is_admin) {
          window.location.href = 'login.html';
          return;
        }

        document.getElementById('gateMsg').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      }

      async function loadStudents() {
        const { data, error } = await window.supabase
          .from('students')
          .select('id, data, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error(error);
          return;
        }
        const tbody = document.querySelector('#studentsTable tbody');
        tbody.innerHTML = '';
        for (const row of data) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.id}</td><td><pre>${JSON.stringify(row.data, null, 2)}</pre></td><td>${row.created_at}</td>`;
          tbody.appendChild(tr);
        }
      }

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await window.supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      (async () => {
        await requireAdmin();
        await loadStudents();
      })();
    </script>
    
  </body>
</html>
